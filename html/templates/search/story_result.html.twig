{% extends "base.html.twig" %}

{% block body %}
<div class="card-group support mt-3 mt-lg-5">
    <div class="card border-dark">

        <div class="card-title p-3">
        
            <h2 class="">Search Rising Stars</h2>

            <form action="{{ path('app_story_search') }}" method="POST" class="row g-3">
                {{ form_widget(form._token) }}
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                    {{ form_widget(form.query, {'attr': {'placeholder': 'The Pub Between', 'class': 'form-control'}}) }}
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </div>
            </form>
        </div>

        <div class="card-body">
            <h1><a href="{{ story.storyAddress }}">{{ story.storyName }}</a>{% if story.storyAuthor %}<span class="h5"> - by {{ story.storyAuthor }}</span>{% endif %}</h1>

            <h2 class="mt-6 text-center">Current Positions</h2>
            
            <div class="row justify-content-center">
                <div class="col-12 col-md-6 text-center">
                    <div id="spinner" class="my-3 d-none">
                        <div class="spinner-border text-primary" role="status"></div>
                        <br/><span class="">Searching... please wait, this may take up to two minutes...</span>
                    </div>
                    <a href="#" id="loadDataBtn" class="btn btn-lg btn-info w-50 text-center">Fetch Current RS Positions</a>
                    <table class="table table-hover d-none" id="rsResults">
                        <thead>
                            <tr>
                                <th class="text-center">RS list</th>
                                <th class="text-center">Current Position</th>
                            </tr>
                        </thead>
                        <tbody id="rsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <h2 class="mt-6 text-center">Historic Positions</h2>
            <p class="card-title p-3" style="font-size: small;">Each time the story gets on a list, a new row is created in the table. If it fall off the list and gets back on it a few days later, that will be two different rows with two different durations. The highest position the story reached during each run on the list is what is displayed here.</p>
            <table class="table table-hover" id="historicResults">
                <thead>
                    <tr>
                        <th>Entered List</th>
                        <th>RS List</th>
                        <th>Highest Position</th>
                        <th>Consecutive<br/>Time on RS</th>
                    </tr>
                </thead>
                <tbody>
                {% set allTags = ['main', 'adventure', 'action', 'comedy', 'contemporary', 'drama', 'fantasy', 'historical', 'horror', 'mystery', 'psychological', 'romance', 'satire', 'sci_fi', 'one_shot', 'tragedy'] %}
                {% for match in story.RSMatches %}
                    {% if match.genre in allTags %}
                    <tr>
                        <td data-order="{{match.date|date("Ymd")}}">{{match.date|date("M d, Y")}}</td>
                        <td>{{match.genre|replace({'_': ' '})|title}}</td>
                        <td>{{match.highestPosition}} {% if match.active %}<i class="fa fa-star"></i>{% endif %}</td>
                        <td data-order="{{match.timeOnListInt}}">{{match.timeOnList}} </td>
                    </tr>
                    {% else %}
                        {% if app.user and app.user.isSubscribed and app.user.getDisplayHiddenLists %}
                        <tr>
                            <td data-order="{{match.date|date("Ymd")}}">{{match.date|date("M d, Y")}}</td>
                            <td>{{match.genre|replace({'_': ' '})|title}}</td>
                            <td>{{match.highestPosition}} {% if match.active %}<i class="fa fa-star"></i>{% endif %}</td>
                            <td data-order="{{match.timeOnListInt}}">{{match.timeOnList}} </td>
                        </tr>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                </tbody>
                <tfoot>
                    <td scope="row" colspan="5"><i class="fa fa-star"></i> = this title is currently on this list!</td>
                </tfoot>
            </table>

            
            {% if app.user and not app.user.isSubscribed or not app.user  %}
                {% include 'partials/_ad_unlock_block.html.twig' %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    <script>
        $('#historicResults').DataTable({
            pageLength: 50,
                order: [
                    [1, 'asc']
                ]
        });
    </script>

    
<script>
    document.getElementById('loadDataBtn').addEventListener('click', async (e) => {
    e.preventDefault();

    const table = document.getElementById('rsResults'); 
    const tbody = document.getElementById('rsTableBody');
    const spinner = document.getElementById('spinner');
    const loadDataBtn = document.getElementById('loadDataBtn');

    tbody.innerHTML = ''; 
    spinner.classList.remove('d-none');
    loadDataBtn.classList.add('d-none'); 

    let dataTableInstance = table.DataTable || null;

    if (!dataTableInstance) {
        dataTableInstance = new DataTable(table, {
            paging: false,
            searching: false,
            info: false,
            order: [
                [1, 'desc']
            ]
        });
    }

    try {
        const res = await fetch(`/get-current-position?story_id={{story.storyid}}`);
        const data = await res.json();

        const rows = [];
        for (const [genre, position] of Object.entries(data)) {
            rows.push([`<a href="https://www.royalroad.com/fictions/rising-stars?genre=${genre}#:~:text={{ story.storyName }}">${genre}</a>`, position]);
        }

        dataTableInstance.clear();
        dataTableInstance.rows.add(rows);
        dataTableInstance.draw();

    } catch (error) {
        console.error('Error fetching positions:', error);
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="2">Failed to load data.</td>`;
        tbody.appendChild(row);
    }

    spinner.classList.add('d-none'); 
    table.classList.remove('d-none'); 
    loadDataBtn.classList.remove('d-none');
    loadDataBtn.textContent = 'Reload Current RS Positions';
});

</script>


{% endblock %}